<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Post Detail</title>
</head>
<body>
<div class="container">
    <h1>게시글 상세</h1>

    <!-- 게시글 정보 표시 -->
    <div class="post-detail">
        <table>
            <tr>
                <th>ID</th>
                <td id="postId"></td>
            </tr>
            <tr>
                <th>제목</th>
                <td id="postTitle"></td>
            </tr>
            <tr>
                <th>내용</th>
                <td id="postContent"></td>
            </tr>
            <tr>
                <th>작성자</th>
                <td id="postAuthor"></td>
            </tr>
            <tr>
                <th>작성일</th>
                <td id="postDate"></td>
            </tr>
            <tr>
                <th>조회수</th>
                <td id="postViewCount"></td>
            </tr>
        </table>
    </div>

    <!-- 수정 버튼 추가 -->
    <div class="edit-button">
        <button type="button" id="editButton" style="display:none;">수정하기</button>
    </div>

    <!-- 삭제 버튼 추가 -->
    <div class="delete-button">
        <button type="button" id="deleteButton" style="display:none;">삭제하기</button>
    </div>

    <!-- 댓글 목록 표시 -->
    <div class="comments">
        <h2>댓글</h2>
        <ul id="commentsList">

        </ul>
    </div>

    <!-- 댓글 작성 -->
    <div class="comment-form">
        <input type="hidden" id="postIdValue">
        <textarea id="commentContent" placeholder="댓글을 입력하세요"></textarea>
        <button type="button" onclick="submitComment()">댓글 작성</button>
    </div>

    <div class="back-to-home">
        <a href="/home">목록으로 돌아가기</a>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const postId = window.location.pathname.split("/").pop(); // URL에서 post ID 추출
        fetchPostDetail(postId);
        fetchComments(postId);
    });

    function fetchPostDetail(postId) {
        fetch(`/api/post/${postId}`,{credentials: 'include'})
            .then(response => response.json())
            .then(data => {
                document.getElementById("postId").textContent = data.id;
                document.getElementById("postTitle").textContent = data.title;
                document.getElementById("postContent").textContent = data.content;
                document.getElementById("postAuthor").textContent = data.authorName;
                document.getElementById("postDate").textContent = new Date(data.created).toLocaleString();
                document.getElementById("postViewCount").textContent = data.viewCount;

                // 댓글 작성 폼에 postId 설정
                document.getElementById("postIdValue").value = data.id;

                if (data.checkAuth) {
                document.getElementById("editButton").style.display = "block";
                document.getElementById("editButton").addEventListener("click", function() {
                    window.location.href = `/post/edit/${data.id}`;
                    });

                document.getElementById("deleteButton").style.display = "block";
                document.getElementById("deleteButton").addEventListener("click", function() {
                    if (confirm("정말로 이 게시글을 삭제하시겠습니까?")) {
                        deletePost(data.id);
                    }
                });
                } else {
                document.getElementById("editButton").style.display = "none";
                document.getElementById("deleteButton").style.display = "none";
                }
            })
            .catch(error => {
                console.error("Error fetching post detail:", error);
            });
    }

    function fetchComments(postId) {
    fetch(`/api/comment/${postId}`)
        .then(response => response.json())
        .then(comments => {
            const commentsList = document.getElementById("commentsList");
            commentsList.innerHTML = ""; // Clear existing comments

            comments.forEach(comment => {
                const li = document.createElement("li");

                const strong = document.createElement("strong");
                strong.textContent = `${comment.displayName}: `;

                const span = document.createElement("span");
                span.textContent = comment.content;

                li.appendChild(strong);
                li.appendChild(span);

                commentsList.appendChild(li);
            });
        })
        .catch(error => {
            console.error("Error fetching comments:", error);
        });
    }


    function submitComment() {
        const content = document.getElementById("commentContent").value;
        const postId = document.getElementById("postIdValue").value;

        fetch("/api/comment", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                content: content,
                postId: postId
            })
        })
        .then(response => response.json())
        .then(data => {
            location.reload(); // 댓글 작성 후 페이지 새로고침
        })
        .catch(error => {
            console.error("Error submitting comment:", error);
            alert("댓글 작성 중 오류가 발생했습니다.");
        });
    }

    function deletePost(postId) {
    fetch(`/api/post/${postId}`, {
        method: "DELETE",
        credentials: 'include'
    })
    .then(response => {
        if (response.ok) {
            alert("게시글이 삭제되었습니다.");
            window.location.href = "/home";
        } else if (response.status === 403) {
            alert("게시글 삭제 권한이 없습니다.");
        } else {
            alert("게시글 삭제에 실패했습니다.");
        }
    })
    .catch(error => {
        console.error("Error deleting post:", error);
        alert("오류가 발생했습니다.");
    });
}

</script>

</body>
</html>
